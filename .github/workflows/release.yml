name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Validate package
        run: |
          echo "Validating package structure..."
          
          required_files=(
            "package/metadata.json"
            "package/contents/ui/main.qml"
            "package/contents/ui/FullRepresentation.qml"
            "package/contents/ui/CompactRepresentation.qml"
            "package/contents/ui/BrowserDelegate.qml"
          )
          
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ Missing required file: $file"
              exit 1
            fi
            echo "✓ Found: $file"
          done
          
          # Validate JSON
          python3 -c "import json; json.load(open('package/metadata.json'))"
          echo "✓ metadata.json is valid"

      - name: Build plasmoid package
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PACKAGE_NAME="browser-switcher-${VERSION}.plasmoid"
          
          echo "Building ${PACKAGE_NAME}..."
          
          cd package
          zip -r "../${PACKAGE_NAME}" . -x "*.git*"
          cd ..
          
          echo "Package contents:"
          unzip -l "${PACKAGE_NAME}"
          
          sha256sum "${PACKAGE_NAME}" > "${PACKAGE_NAME}.sha256"
          echo "SHA256: $(cat ${PACKAGE_NAME}.sha256)"

      - name: Extract changelog for version
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # Extract section for this version from CHANGELOG.md
          if [ -f "CHANGELOG.md" ]; then
            # Get content between this version header and next version header
            NOTES=$(awk "/^## \[${VERSION}\]/{flag=1; next} /^## \[/{flag=0} flag" CHANGELOG.md)
            
            if [ -n "$NOTES" ]; then
              echo "Found changelog for v${VERSION}"
              # Save to file for multiline support
              echo "$NOTES" > release_notes_body.md
            else
              echo "No changelog entry found for v${VERSION}, using default"
              echo "Release v${VERSION}" > release_notes_body.md
            fi
          else
            echo "No CHANGELOG.md found, using default"
            echo "Release v${VERSION}" > release_notes_body.md
          fi

      - name: Generate release notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          cat << 'HEADER' > release_notes.md
          ## Installation
          
          ### Option 1: Command Line
          ```bash
          kpackagetool6 -t Plasma/Applet -i browser-switcher-${{ steps.version.outputs.version }}.plasmoid
          ```
          
          ### Option 2: Plasma UI
          1. Right-click on desktop or panel
          2. Select "Add Widgets..." → "Get New Widgets..." → "Install from Local File..."
          3. Select the downloaded `.plasmoid` file
          
          ### Upgrade Existing Installation
          ```bash
          kpackagetool6 -t Plasma/Applet -u browser-switcher-${{ steps.version.outputs.version }}.plasmoid
          ```
          
          ### Uninstall
          ```bash
          kpackagetool6 -t Plasma/Applet -r org.kde.plasma.browserswitcher
          ```
          
          ## Requirements
          - KDE Plasma 6.0 or later
          - `xdg-utils` package
          
          ## Changes
          
          HEADER
          
          cat release_notes_body.md >> release_notes.md
          
          echo "" >> release_notes.md
          echo "---" >> release_notes.md
          echo "**Checksum:** See \`browser-switcher-${{ steps.version.outputs.version }}.plasmoid.sha256\`" >> release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Browser Switcher v${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, 'beta') || contains(steps.version.outputs.version, 'alpha') || contains(steps.version.outputs.version, 'rc') }}
          files: |
            *.plasmoid
            *.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
