name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.2.0)'
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Validate package structure
        run: |
          echo "Validating package structure..."
          
          # Check required files exist
          required_files=(
            "package/metadata.json"
            "package/contents/ui/main.qml"
            "package/contents/ui/FullRepresentation.qml"
            "package/contents/ui/CompactRepresentation.qml"
            "package/contents/ui/BrowserDelegate.qml"
            "package/contents/config/main.xml"
            "package/contents/config/config.qml"
          )
          
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ Missing required file: $file"
              exit 1
            fi
            echo "✓ Found: $file"
          done
          
          # Validate metadata.json
          echo "Validating metadata.json..."
          if ! python3 -c "import json; json.load(open('package/metadata.json'))"; then
            echo "❌ Invalid JSON in metadata.json"
            exit 1
          fi
          echo "✓ metadata.json is valid JSON"
          
          # Check version matches
          METADATA_VERSION=$(python3 -c "import json; print(json.load(open('package/metadata.json'))['KPlugin']['Version'])")
          echo "Version in metadata.json: $METADATA_VERSION"

      - name: Build plasmoid package
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PACKAGE_NAME="browser-switcher-${VERSION}.plasmoid"
          
          echo "Building ${PACKAGE_NAME}..."
          
          cd package
          zip -r "../${PACKAGE_NAME}" . -x "*.git*"
          cd ..
          
          # Verify the package
          echo "Package contents:"
          unzip -l "${PACKAGE_NAME}"
          
          # Calculate checksum
          sha256sum "${PACKAGE_NAME}" > "${PACKAGE_NAME}.sha256"
          echo "SHA256: $(cat ${PACKAGE_NAME}.sha256)"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: plasmoid-package
          path: |
            *.plasmoid
            *.sha256

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: plasmoid-package

      - name: Generate release notes
        id: notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          cat << 'EOF' > release_notes.md
          ## Browser Switcher v${{ steps.version.outputs.version }}
          
          Quick default browser switching for KDE Plasma 6.
          
          ### Installation
          
          **Option 1: Using kpackagetool6**
          ```bash
          kpackagetool6 -t Plasma/Applet -i browser-switcher-${{ steps.version.outputs.version }}.plasmoid
          ```
          
          **Option 2: Via Plasma UI**
          1. Right-click on your desktop or panel
          2. Select "Add Widgets..." → "Get New Widgets..." → "Install from Local File..."
          3. Select the downloaded `.plasmoid` file
          
          ### Upgrade
          ```bash
          kpackagetool6 -t Plasma/Applet -u browser-switcher-${{ steps.version.outputs.version }}.plasmoid
          ```
          
          ### Uninstall
          ```bash
          kpackagetool6 -t Plasma/Applet -r org.kde.plasma.browserswitcher
          ```
          
          ### Requirements
          - KDE Plasma 6.0 or later
          - `xdg-utils` package (provides `xdg-settings`)
          
          ### Checksums
          See `browser-switcher-${{ steps.version.outputs.version }}.plasmoid.sha256` for SHA256 checksum.
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Browser Switcher v${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, 'beta') || contains(steps.version.outputs.version, 'alpha') || contains(steps.version.outputs.version, 'rc') }}
          files: |
            *.plasmoid
            *.sha256
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
